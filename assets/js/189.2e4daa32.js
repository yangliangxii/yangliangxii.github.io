(window.webpackJsonp=window.webpackJsonp||[]).push([[189],{513:function(s,n,a){"use strict";a.r(n);var e=a(3),t=Object(e.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("blockquote",[n("p",[s._v("说明：本章内容为博主在原教程基础上添加自己的学习笔记，来源"),n("a",{attrs:{href:"https://t.bilibili.com/724961282549088304?share_source=pc_native/",target:"_blank",rel:"noopener noreferrer"}},[s._v("全网Vue3最详细源码解析"),n("OutboundLink")],1),s._v("，教程版权归原作者所有。")])]),s._v(" "),n("h1",{attrs:{id:"配置环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置环境"}},[s._v("#")]),s._v(" 配置环境")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("monorepo优点")]),s._v(" "),n("ul",[n("li",[s._v("monorepo管理项目：是项目管理的一个方式，在一个项目仓库中管理多个包/模块，将代码拆分到各个模块package中。")]),s._v(" "),n("li",[s._v("一个仓库维护多个模块，不用到处找仓库。")]),s._v(" "),n("li",[s._v("方便版本管理和依赖管理，模块之间的调用和引用都非常方便。")]),s._v(" "),n("li",[s._v("模块扩展非常方便。")])])]),s._v(" "),n("p",[n("img",{attrs:{src:"/img/vue3-src-jiagou.png",alt:"vue3源码工程结构图"}})]),s._v(" "),n("h2",{attrs:{id:"项目初始化安装依赖包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#项目初始化安装依赖包"}},[s._v("#")]),s._v(" 项目初始化安装依赖包")]),s._v(" "),n("ul",[n("li",[s._v("Step 0 - 创建项目目录vue3-src")]),s._v(" "),n("li",[s._v("Step 1 - 初始化 yarn init -y，打开package.json 添加\n"),n("code",[s._v('"private": true, "workspaces": [ "packages/*" ],')])]),s._v(" "),n("li",[s._v("Step 2 - 创建packages目录")]),s._v(" "),n("li",[s._v("Step 3 - 创建packages/reactivity目录并初始化 yarn init -y,打开package.json 修改\n"),n("code",[s._v('"name": "@vue/reactivity",')])]),s._v(" "),n("li",[s._v("Step 4 - 创建packages/shared目录并初始化 yarn init -y，打开package.json 修改\n"),n("code",[s._v('"name": "@vue/shared",')])]),s._v(" "),n("li",[s._v("Step 5 - 在packages/shared目录下新建src目录，在packages/shared/src下新建index.ts文件")]),s._v(" "),n("li",[s._v("Step 6 - 在packages/reactivity目录下新建src目录，在packages/shared/src下新建index.ts文件")]),s._v(" "),n("li",[s._v("Step 7 - 在vue3-src下添加typescript包   "),n("code",[s._v("yarn add -D -W typescript")])]),s._v(" "),n("li",[s._v("Step 8 - 在vue3-src下添加执行命令   "),n("code",[s._v("npx tsc --init")]),s._v("在根目录下生成tsconfig.json文件")])]),s._v(" "),n("h2",{attrs:{id:"安装rollup打包依赖"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装rollup打包依赖"}},[s._v("#")]),s._v(" 安装rollup打包依赖")]),s._v(" "),n("p",[s._v("根目录下执行命令"),n("code",[s._v("yarn add typescript@^4.8.0 rollup@3.2.3 rollup-plugin-typescript2@0.34.1 @rollup/plugin-node-resolve@15.0.1 @rollup/plugin-json@5.0.1 @rollup/plugin-commonjs@^23.0.2 execa@^4.0.2 minimist@^1.2.0 -D -W")])]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("ul",[n("li",[s._v("[@rollup/plugin-node-resolve]：处理解决第三方插件")]),s._v(" "),n("li",[s._v("[@rollup/plugin-json]：处理json的")]),s._v(" "),n("li",[s._v("[execa]：解决子继承")]),s._v(" "),n("li",[s._v("[rollup-plugin-typescript2]：解析ts的")])])]),s._v(" "),n("h2",{attrs:{id:"打包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#打包"}},[s._v("#")]),s._v(" 打包")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("在每个子模块package.json中配置打包文件格式\n"),n("code",[s._v('"buildOptions": { "name": "VueReactivity", "formats": [ "esm-bundler", "cjs", "global" ] }')]),s._v(" "),n("code",[s._v('"buildOptions": { "name": "VueShared", "formats": [ "esm-bundler", "cjs" ] }')])]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("ul",[n("li",[s._v("[esm-bundler]：处理es6.js")]),s._v(" "),n("li",[s._v("[cjs]：处理common.js")]),s._v(" "),n("li",[s._v("[global]：处理全局的东西")])])])]),s._v(" "),n("li",[n("p",[s._v("实现scripts/build.js功能")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("使用monorepo进行打包")])]),s._v(" "),n("ul",[n("li",[s._v("获取打包目录")]),s._v(" "),n("li",[s._v("实现并行打包")])])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("    //import execa from 'execa'\n    const fs = require('fs')//加载node模块\n    const execa = require('execa')\n\n    // 1 获取模块目录\n    //const dirs = fs.readdirSync('packages'); //使用fs核心模块读取packages下所有目录，包括文件\n    //console.info(dirs);\n\n    const dirs = fs.readdirSync('packages').filter(f => {\n        if (!fs.statSync(`packages/${f}`).isDirectory()) {\n            return false\n        }\n        return true\n    }); //使用fs核心模块读取packages下所有目录，包括文件,使用filter方法过滤掉不是目录的文件名\n    console.info(dirs);\n\n    // 2 并行打包\n    async function build(target) {\n        console.info(target, '<--build--\x3e');\n        //rollup表示打包工具  -c表示执行rollup的配置  --environment环境变量\n        await execa('rollup', ['-c', '--environment', `TARGET:${target}`], { stdio: 'inherit' });\n    }\n\n    async function runParaller(dirs, itemfn) {\n        let result = [];\n        for (let item of dirs) {\n            result.push(itemfn(item));\n        }\n        return Promise.all(result);//存放打包的promise\n    }\n\n    runParaller(dirs, build).then(() => {\n        console.info(\"打包成功\");\n    });\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br")])]),n("ul",[n("li",[s._v("配置rollup.config.mjs文件")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  // 1引入相关依赖\n  import { createRequire } from 'module'\n  import { fileURLToPath } from 'url'\n  import path, { format } from 'path' //处理路径的(node中的模块)\n\n  import ts from 'rollup-plugin-typescript2' //解析ts\n  import json from '@rollup/plugin-json' //解析json\n  import resolvePlugin from '@rollup/plugin-node-resolve' //解析第三方插件\n\n  const require = createRequire(import.meta.url)\n  const __dirname = fileURLToPath(new URL('.', import.meta.url))\n\n  // 2.1 获取存放package的根路径\n  let packagesDir = path.resolve(__dirname, 'packages');//获取packages在项目中的绝对路径,__dirname获取项目的绝对路径\n  console.info(packagesDir, __dirname, '<--rollup.config.js--\x3e');\n  // 2.2 获取每个包的路径和相关配置\n  let packageDir = path.resolve(packagesDir, process.env.TARGET);//拿到需要打包的目录(process.env.TARGET是node里的方法)\n  console.info(packageDir, '<--rollup.config.js--\x3e');\n  const resolve = p => path.resolve(packageDir, p);\n  const pkg = require(resolve('package.json'));//自定义的package.json文件\n  const packageOptions = pkg.buildOptions || {};\n  const name = packageOptions.filename || path.basename(packageDir);\n  console.info(pkg, '<--rollup.config.js--\x3e');\n  // 3 创建一个表\n  const outputOptions = {\n      'esm-bundler': {\n          file: resolve(`dist/${name}.esm-bundler.js`),\n          format: 'es'\n      },\n      'cjs': {\n          file: resolve(`dist/${name}.cjs.js`),\n          format: 'cjs'\n      },\n      'global': {\n          file: resolve(`dist/${name}.global.js`),\n          format: 'iife'\n      },\n  }\n\n  const options = packageOptions;\n  function createConfig(format, output) {\n      output.name = options.name;\n      output.sourcemap = true;//调试代码\n      return {\n          input: resolve('src/index.ts'),//导入\n          output,\n          plugins: [\n              json(),\n              ts({//解析ts\n                  tsconfig: path.resolve(__dirname, 'tsconfig.json')\n              }),\n              resolvePlugin()\n          ]\n      }\n  }\n  //rollup 需要一个返回项\n  export default options.formats.map(format => createConfig(format, outputOptions[format]));\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br")])]),n("ul",[n("li",[s._v("实现scripts/dev.js功能(写死-测试)"),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("  //import execa from 'execa'\n  //const fs = require('fs')//加载node模块\n  const execa = require('execa')\n\n  // 1 获取模块目录\n  //const dirs = fs.readdirSync('packages'); //使用fs核心模块读取packages下所有目录，包括文件\n  //console.info(dirs);\n\n  // const dirs = fs.readdirSync('packages').filter(f => {\n  //     if (!fs.statSync(`packages/${f}`).isDirectory()) {\n  //         return false\n  //     }\n  //     return true\n  // }); //使用fs核心模块读取packages下所有目录，包括文件,使用filter方法过滤掉不是目录的文件名\n  // console.info(dirs);\n\n  // 2 并行打包\n  async function build(target) {\n      console.info(target, '<--build--\x3e');\n      //rollup表示打包工具  -c表示执行rollup的配置  --environment环境变量 -w表示自动打包\n      await execa('rollup', ['-cw', '--environment', `TARGET:${target}`], { stdio: 'inherit' });\n  }\n\n  // async function runParaller(dirs, itemfn) {\n  //     let result = [];\n  //     for (let item of dirs) {\n  //         result.push(itemfn(item));\n  //     }\n  //     return Promise.all(result);//存放打包的promise\n  // }\n\n  // runParaller(dirs, build).then(() => {\n  //     console.info(\"打包成功\");\n  // });\n\n  build('reactivity');\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br")])])])])])}),[],!1,null,null,null);n.default=t.exports}}]);