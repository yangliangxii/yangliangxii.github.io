(window.webpackJsonp=window.webpackJsonp||[]).push([[216],{540:function(s,n,e){"use strict";e.r(n);var a=e(3),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("blockquote",[n("p",[s._v("说明：本章内容为博主在原教程基础上添加自己的学习笔记，来源"),n("a",{attrs:{href:"https://www.bilibili.com/video/BV1KB4y1g7jb?vd_source=a776fb95f6de3e1354e0f23cebc134d3",target:"_blank",rel:"noopener noreferrer"}},[s._v("珠峰架构Vue3课程"),n("OutboundLink")],1),s._v("，版权归原作者所有。")])]),s._v(" "),n("h1",{attrs:{id:"响应式源码分析与实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#响应式源码分析与实现"}},[s._v("#")]),s._v(" 响应式源码分析与实现")]),s._v(" "),n("h2",{attrs:{id:"reactivity包结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#reactivity包结构"}},[s._v("#")]),s._v(" reactivity包结构")]),s._v(" "),n("ul",[n("li",[s._v("index.ts：这是包的入口文件，负责暴露(导出)包下所有的api接口给外部调用")]),s._v(" "),n("li",[s._v("reactive.ts：处理响应式，核心是proxy，柯里化函数转换，高阶函数，函数是否是只读，是否是深度处理")]),s._v(" "),n("li",[s._v("effect.ts：核心api，响应式核心原理就是每次get对象属性的时候收集effect，每次set对象属性的时候获取effect去执行更新")]),s._v(" "),n("li",[s._v("computed.ts：实际也是一个effect，计算属性的依赖属性会搜集这个effect")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("    //导出方法，不实现功能\n\n    //响应式重要api\n    export {\n        reactive,\n        shallowReactive,\n        readonly,\n        shallowReadonly\n    } from './reactive'\n\n    //响应式核心api\n    export {\n        effect\n    } from './effect'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("center",[s._v(" index.ts ")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("高阶函数")]),s._v(" "),n("p",[s._v("函数的参数或者返回值是函数")])]),s._v(" "),n("h2",{attrs:{id:"shared-index"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#shared-index"}},[s._v("#")]),s._v(" shared-index")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("shared")]),s._v(" "),n("p",[s._v("给其他包提供公用的功能")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("export const isObject = (value) => typeof value == 'object' && value !== null\nexport const extend = Object.assign\nexport const isArray = Array.isArray\nexport const isFunction = (value) => typeof value == 'function'\nexport const isNumber = (value) => typeof value == 'number'\nexport const isString = (value) => typeof value == 'string'\nexport const isIntegerKey = (key) => typeof parseInt(key) + '' === key\nlet hasOwnProperty = Object.prototype.hasOwnProperty\nexport const hasOwn = (target, key) => hasOwnProperty.call(target, key)\nexport const hasChanged = (oldValue, value) => oldValue !== value\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("center",[s._v(" index.ts ")]),s._v(" "),n("h2",{attrs:{id:"reactive"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#reactive"}},[s._v("#")]),s._v(" reactive")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("可读可写，代理对象所有层级属性(只要是对象)")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('import { isObject } from "@vue/shared"\nimport { reactiveHandlers, shallowReactiveHandlers, readonlyHandlers, shallowReadonlyHandlers } from "./baseHandlers"\n\n/*\n    @这四个方法表示了是不是只读，是不是深度 \n*/\nexport function reactive(target) {\n    return createReactiveObject(target, false, reactiveHandlers)//false不是只读\n}\n\nexport function shallowReactive(target) {\n    return createReactiveObject(target, false, shallowReactiveHandlers)//false不是只读\n}\n\nexport function readonly(target) {\n    return createReactiveObject(target, true, readonlyHandlers)//true是只读\n}\n\nexport function shallowReadonly(target) {\n    return createReactiveObject(target, true, shallowReadonlyHandlers)//true是只读\n}\n\nconst reactiveMap = new WeakMap()//WeakMap会自动垃圾回收，不会造成内存泄漏，key只能是object\nconst readonlyMap = new WeakMap()\n\n/*\n    @四个方法根据不同的参数实现不同的逻辑，\n    柯里化方，\n    工厂方法，\n    底层使用Proxy，\n    最核心的是要拦截数据的读取和修改\n*/\nexport function createReactiveObject(target, isReadonly = true, baseHandlers) {\n    //如果传入的target不是对象，那么就无法拦截。reactive只能拦截Object类型的对象\n    if (!isObject(target)) {\n        return target\n    }\n\n    //按照是否只读获取到对应的map\n    const proxyMap = isReadonly ? readonlyMap : reactiveMap\n    //如果这个对象已经被代理过了就不要再次代理了\n    const existedProxy = proxyMap.get(target)\n    if (existedProxy) {\n        return existedProxy\n    }\n    //如果这个对象还未被代理，那么就创建一个代理对象并缓存起来\n    const proxy = new Proxy(target, baseHandlers)\n    //将代理对象和代理缓存到map\n    proxyMap.set(target, proxy)\n    return proxy\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br")])]),n("center",[s._v(" reactive代码 ")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>test reactive api</title>\n</head>\n\n<body>\n    <script src="../dist/reactivity.global.js"><\/script>\n\n    <script>\n        const { reactive} = VueReactivity\n        let person = { name: \'yangliangxi\', age: 20, sex: \'男\', info: { com: \'thtf\', depart: { responsibility: \'programer\', leader: \'wuyanjun\' } } }\n\n        let proxyPerson = reactive(person)\n        console.log("01 非只读且深代理")\n        console.log("非只读且深代理输出整个对象---\x3e", proxyPerson)\n        console.log("非只读且深代理输出对象的proxyPerson.age属性---\x3e", proxyPerson.age)\n        console.log("非只读且深代理输出对象的proxyPerson.info属性---\x3e", proxyPerson.info)\n        console.log("非只读且深代理输出对象的proxyPerson.info.depart属性---\x3e", proxyPerson.info.depart)\n        console.log("")\n    <\/script>\n</body>\n\n</html>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br")])]),n("center",[s._v(" reactive用例 ")]),s._v(" "),n("h2",{attrs:{id:"shallowreactive"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#shallowreactive"}},[s._v("#")]),s._v(" shallowReactive")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("可读可写，只代理对象最外层属性(嵌套的对象不代理，输出原来的对象)")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>test shallowReactive api</title>\n</head>\n\n<body>\n    <script src="../dist/reactivity.global.js"><\/script>\n\n    <script>\n        const { shallowReactive } = VueReactivity\n        let person = { name: \'yangliangxi\', age: 20, sex: \'男\', info: { com: \'thtf\', depart: { responsibility: \'programer\', leader: \'wuyanjun\' } } }\n\n        let proxyPerson = shallowReactive(person)\n        console.log("02 非只读且浅代理")\n        console.log("非只读且浅代理输出整个对象---\x3e", proxyPerson)\n        console.log("非只读且浅代理输出对象的proxyPerson.age属性---\x3e", proxyPerson.age)\n        console.log("非只读且浅代理输出对象的proxyPerson.info属性---\x3e", proxyPerson.info)\n        console.log("非只读且浅代理输出对象的proxyPerson.info.depart属性---\x3e", proxyPerson.info.depart)\n        console.log("")\n    <\/script>\n</body>\n\n</html>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br")])]),n("center",[s._v("功能代码见reactive, shallowReactive用例 ")]),s._v(" "),n("h2",{attrs:{id:"readonly"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#readonly"}},[s._v("#")]),s._v(" readonly")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("只读，不可以修改对象任意层级的属性值")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>test readonly api</title>\n</head>\n\n<body>\n    <script src="../dist/reactivity.global.js"><\/script>\n\n    <script>\n        const { readonly} = VueReactivity\n        let person = { name: \'yangliangxi\', age: 20, sex: \'男\', info: { com: \'thtf\', depart: { responsibility: \'programer\', leader: \'wuyanjun\' } } }\n\n        let proxyPerson = readonly(person)\n        console.log("03 只读")\n        console.log("只读输出整个对象---\x3e", proxyPerson)\n        console.log("只读输出对象的proxyPerson.age属性---\x3e", proxyPerson.age)\n        console.log("只读输出对象的proxyPerson.info属性---\x3e", proxyPerson.info)\n        console.log("只读输出对象的proxyPerson.info.depart属性---\x3e", proxyPerson.info.depart)\n        console.log("只读修改对象的proxyPerson.age属性")\n        proxyPerson.age = 200\n        console.log("只读修改对象的proxyPerson.info.depart.leader属性")\n        proxyPerson.info.depart.leader = \'yuanjinghui\'\n        console.log("")\n    <\/script>\n</body>\n\n</html>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br")])]),n("center",[s._v("功能代码见reactive,  readonly用例 ")]),s._v(" "),n("h2",{attrs:{id:"shallowreadonly"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#shallowreadonly"}},[s._v("#")]),s._v(" shallowReadonly")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("p",[s._v("浅只读，不可以修改对象最外层的属性值，嵌套的属性值可以修改")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>test shallowReadonly api</title>\n</head>\n\n<body>\n    <script src="../dist/reactivity.global.js"><\/script>\n\n    <script>\n        const { shallowReadonly } = VueReactivity\n        let person = { name: \'yangliangxi\', age: 20, sex: \'男\', info: { com: \'thtf\', depart: { responsibility: \'programer\', leader: \'wuyanjun\' } } }\n\n        let proxyPerson = shallowReadonly(person)\n        console.log("04 只读且浅代理")\n        console.log("只读且浅代理输出整个对象---\x3e", proxyPerson)\n        console.log("只读且浅代理输出对象的proxyPerson.age属性---\x3e", proxyPerson.age)\n        console.log("只读且浅代理输出对象的proxyPerson.info属性---\x3e", proxyPerson.info)\n        console.log("只读且浅代理输出对象的proxyPerson.info.depart属性---\x3e", proxyPerson.info.depart)\n        console.log("只读且浅代理修改对象的proxyPerson.age属性")\n        proxyPerson.age = 200\n        console.log("只读且浅代理修改对象的proxyPerson.info.depart.leader属性")\n        proxyPerson.info.depart.leader = \'yuanjinghui\'\n        console.log("")\n\n    <\/script>\n</body>\n\n</html>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br")])]),n("center",[s._v("功能代码见reactive,  shallowReadonly用例 ")]),s._v(" "),n("h2",{attrs:{id:"effect"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#effect"}},[s._v("#")]),s._v(" effect")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("提示")]),s._v(" "),n("ul",[n("li",[s._v("effect中对象的所有属性get时都会收集effect，当这个属性的值发生变化set时会重新执行effect")]),s._v(" "),n("li",[s._v("get时调用track方法，set时调用trigger方法")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("import { isArray, isIntegerKey, isNumber } from \"@vue/shared\";\nimport { TrackOpTypes, TriggerOpTypes } from \"./operators\"\n\nlet uid = 0\nlet activeEffect;//当前激活的effect（执行的effect）\nconst effectStack = []//effect栈\nfunction createReactiveEffect(fn, options) {\n    const effect = function reactiveEffect() {\n        if (!effectStack.includes(effect)) {//如果栈里不存在这个函数就push进\n            try {\n                effectStack.push(effect)//每次先把effect入栈\n                activeEffect = effect//标致当前正在执行的effect\n                return fn()//这个是用户通过effect传过来的函数，一般这个方法中会包含对象属性的取值，所以会执行get方法\n            }\n            finally {\n                effectStack.pop()//执行完effect后需要把这个effect出栈\n                activeEffect = effectStack[effectStack.length - 1]//effect出栈后需要将当前激活的effect标识成栈里最后一个effect\n            }\n        }\n    }\n\n    effect.id = uid++//标识effect，目的是进行区分\n    effect._isEffect = true//标识这个effect是响应式的\n    effect.raw = fn//记录原函数\n    effect.options = options//记录配置选项\n\n    return effect\n}\n\n//让对象的某个属性收集当前它对应的effect函数\nexport function effect(fn, options: any = {}) {\n    //需要让这个effect变成响应式的effect，可以做到数据变化重新执行\n    const _effect = createReactiveEffect(fn, options)\n    if (!options.lazy) {//如果不是懒模式默认会被执行一次\n        _effect()\n    }\n    return _effect\n}\n\n/*\n @收集属性和effect的映射\n*/\n\nconst targetMap = new WeakMap()\nexport function track(target, type: TrackOpTypes, key) {\n    if (activeEffect === undefined) {//此属性不用收集依赖，因为没在effect中使用\n        return\n    }\n\n    let depsMap = targetMap.get(target)\n    if (!depsMap) {\n        targetMap.set(target, depsMap = new Map)\n    }\n\n    let dep = depsMap.get(key)\n    if (!dep) {\n        depsMap.set(key, dep = new Set)\n    }\n    if (!dep.has(activeEffect)) {\n        dep.add(activeEffect)\n    }\n\n    console.log(targetMap)\n}\n\n//找属性对应的effect让其执行，支持数组和对象\nexport function trigger(target, type: TriggerOpTypes, key?, newValue?, oldValue?) {\n    // console.log(target, type, key, newValue, oldValue, \"trigger...\")\n    //如果这个属性没有收集过effect，那么不需要做任何处理\n    const depsMap = targetMap.get(target)\n    if (!depsMap) {\n        return\n    }\n\n    //如果收集了effect，那么就要将所有的effect都放在一个集合中一起执行\n    const effects = new Set()//set具有去重的功能\n\n    const add = (effectsToAdd) => {\n        if (effectsToAdd) {\n            effectsToAdd.forEach((effect) => {\n                effects.add(effect)\n            })\n        }\n    }\n    //首先看是否修改的是数组的长度\n    if (key === 'length' && isArray(target)) {\n        depsMap.forEach((dep, key) => {\n            if (key === 'length' || key > newValue) {\n                add(dep)\n            }\n        });\n    } else {//对象情况\n        if (key !== undefined) {\n            add(depsMap.get(key))\n        }\n        switch (type) {\n            case TriggerOpTypes.ADD:\n                if (isArray(target) && isIntegerKey(key)) {\n                    add(depsMap.get('length'))\n                }\n        }\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br"),n("span",{staticClass:"line-number"},[s._v("85")]),n("br"),n("span",{staticClass:"line-number"},[s._v("86")]),n("br"),n("span",{staticClass:"line-number"},[s._v("87")]),n("br"),n("span",{staticClass:"line-number"},[s._v("88")]),n("br"),n("span",{staticClass:"line-number"},[s._v("89")]),n("br"),n("span",{staticClass:"line-number"},[s._v("90")]),n("br"),n("span",{staticClass:"line-number"},[s._v("91")]),n("br"),n("span",{staticClass:"line-number"},[s._v("92")]),n("br"),n("span",{staticClass:"line-number"},[s._v("93")]),n("br"),n("span",{staticClass:"line-number"},[s._v("94")]),n("br"),n("span",{staticClass:"line-number"},[s._v("95")]),n("br"),n("span",{staticClass:"line-number"},[s._v("96")]),n("br"),n("span",{staticClass:"line-number"},[s._v("97")]),n("br"),n("span",{staticClass:"line-number"},[s._v("98")]),n("br"),n("span",{staticClass:"line-number"},[s._v("99")]),n("br"),n("span",{staticClass:"line-number"},[s._v("100")]),n("br"),n("span",{staticClass:"line-number"},[s._v("101")]),n("br"),n("span",{staticClass:"line-number"},[s._v("102")]),n("br"),n("span",{staticClass:"line-number"},[s._v("103")]),n("br")])]),n("center",[s._v("effect代码 ")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('import { extend, hasChanged, hasOwn, isArray, isIntegerKey, isObject } from "@vue/shared";\nimport { track, trigger } from "./effect";\nimport { TrackOpTypes, TriggerOpTypes } from "./operators";\nimport { reactive, readonly } from "./reactive";\n\n//getter：拦截获取数值\nfunction createGetter(isReadonly = false, shallow = false) {//isReadonly = false, shallow = false表示默认的reactive既不是readonly也不是shallow  \n    return function get(target, key, recevier) {//recevier是个代理对象，谁调用就代指谁\n        //Proxy+Reflect：后续Object的方法会被逐步迁移到Reflect上\n\n        const res = Reflect.get(target, key, recevier)//等价于target[key]，这个操作可能失败，但是不会报异常也不会有返回结果，而Reflect.get具有操作的状态返回给使用者。\n\n        if (!isReadonly) {\n            //搜集依赖，等用户属性数据变化后执行更新，执行effect时会执行用户传入的fn函数，这样就将属性对应的effect收集起来了\n            track(target, TrackOpTypes.GET, key)\n        }\n\n        if (shallow) { return res }\n\n        if (isObject(res)) {\n            return isReadonly ? readonly(res) : reactive(res)\n        }\n\n        return res\n    }\n}\n\n//setter：拦截设置数值\nfunction createSetter(shallow = false) {\n    return function set(target, key, value, recevier) {\n        //Proxy+Reflect：后续Object的方法会被逐步迁移到Reflect上\n        const oldValue = target[key]//获取到旧值\n        let hasKey = isArray(target) && isIntegerKey(key) ? Number(key) < target.length : hasOwn(target, key)//先看下target里有没有key这个属性\n\n        if (!hasKey) {//属性有新增\n            trigger(target, TriggerOpTypes.ADD, key, value)\n        } else if (hasChanged(oldValue, value)) {//属性有修改\n            trigger(target, TriggerOpTypes.SET, key, value, oldValue)\n        }\n        const res = Reflect.set(target, key, value, recevier)//等价于target[key]=value，这个操作可能失败，但是不会报异常也不会有返回结果，而Reflect.set具有操作的状态返回给使用者。\n\n        return res\n    }\n}\n\nconst get = createGetter(false, false);\n\nconst shallowGet = createGetter(false, true);\n\nconst readonlyGet = createGetter(true, false);\n\nconst shallowReadonlyGet = createGetter(true, true);\n\nconst set = createSetter()\n\nconst shallowSet = createSetter(true)\n\n/*\n    @这四个对象表示4种不同的响应处理逻辑，\n    实现new Proxy(target，baseHandlers)中的baseHandlers逻辑\n    是不是只读\n    是不是深度\n*/\nexport const reactiveHandlers = {\n    get,\n    set\n}\n\nexport const shallowReactiveHandlers = {\n    get: shallowGet,\n    set: shallowSet\n}\n\nlet readonlyObj = {//提取出公共的代码\n    set: (target, key) => { console.info(`只读！不能给对象${target}的属性${key}设置数据`) }\n}\n\nexport const readonlyHandlers = extend({//extend是Object.assign，起到合并两个对象的作用，可以去掉重复代码\n    get: readonlyGet,\n}, readonlyObj)\n\nexport const shallowReadonlyHandlers = extend({\n    get: shallowReadonlyGet,\n}, readonlyObj)\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br"),n("span",{staticClass:"line-number"},[s._v("55")]),n("br"),n("span",{staticClass:"line-number"},[s._v("56")]),n("br"),n("span",{staticClass:"line-number"},[s._v("57")]),n("br"),n("span",{staticClass:"line-number"},[s._v("58")]),n("br"),n("span",{staticClass:"line-number"},[s._v("59")]),n("br"),n("span",{staticClass:"line-number"},[s._v("60")]),n("br"),n("span",{staticClass:"line-number"},[s._v("61")]),n("br"),n("span",{staticClass:"line-number"},[s._v("62")]),n("br"),n("span",{staticClass:"line-number"},[s._v("63")]),n("br"),n("span",{staticClass:"line-number"},[s._v("64")]),n("br"),n("span",{staticClass:"line-number"},[s._v("65")]),n("br"),n("span",{staticClass:"line-number"},[s._v("66")]),n("br"),n("span",{staticClass:"line-number"},[s._v("67")]),n("br"),n("span",{staticClass:"line-number"},[s._v("68")]),n("br"),n("span",{staticClass:"line-number"},[s._v("69")]),n("br"),n("span",{staticClass:"line-number"},[s._v("70")]),n("br"),n("span",{staticClass:"line-number"},[s._v("71")]),n("br"),n("span",{staticClass:"line-number"},[s._v("72")]),n("br"),n("span",{staticClass:"line-number"},[s._v("73")]),n("br"),n("span",{staticClass:"line-number"},[s._v("74")]),n("br"),n("span",{staticClass:"line-number"},[s._v("75")]),n("br"),n("span",{staticClass:"line-number"},[s._v("76")]),n("br"),n("span",{staticClass:"line-number"},[s._v("77")]),n("br"),n("span",{staticClass:"line-number"},[s._v("78")]),n("br"),n("span",{staticClass:"line-number"},[s._v("79")]),n("br"),n("span",{staticClass:"line-number"},[s._v("80")]),n("br"),n("span",{staticClass:"line-number"},[s._v("81")]),n("br"),n("span",{staticClass:"line-number"},[s._v("82")]),n("br"),n("span",{staticClass:"line-number"},[s._v("83")]),n("br"),n("span",{staticClass:"line-number"},[s._v("84")]),n("br")])]),n("center",[s._v("baseHandlers代码 ")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("export const enum TrackOpTypes {\n    GET\n}\n\nexport const enum TriggerOpTypes {\n    ADD,\n    SET\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("center",[s._v("operators代码 ")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('<!DOCTYPE html>\n<html lang="en">\n\n<head>\n    <meta charset="UTF-8">\n    <meta http-equiv="X-UA-Compatible" content="IE=edge">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>test effect api</title>\n</head>\n\n<body>\n    <script src="../dist/reactivity.global.js"><\/script>\n\n    <script>\n        const { reactive, effect } = VueReactivity\n        let person = { name: \'yangliangxi\', age: 20, arr: [1, 2, 3] }\n\n        let proxyPerson = reactive(person)\n        // console.log("01 非只读且深代理")\n        // console.log("非只读且深代理输出整个对象---\x3e", proxyPerson)\n        // console.log("非只读且深代理输出对象的proxyPerson.age属性---\x3e", proxyPerson.age)\n        // console.log("非只读且深代理输出对象的proxyPerson.info属性---\x3e", proxyPerson.info)\n        // console.log("非只读且深代理输出对象的proxyPerson.info.depart属性---\x3e", proxyPerson.info.depart)\n        // console.log("")\n\n        effect(() => {\n            console.log(proxyPerson.arr[2], proxyPerson.arr.length)\n        })\n\n        setTimeout(() => {\n            proxyPerson.arr.length = 3//修改数组的长度\n        }, 2000)\n\n    <\/script>\n</body>\n\n</html>\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br")])]),n("center",[s._v("effect用例 ")]),s._v(" "),n("h2",{attrs:{id:"computed"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#computed"}},[s._v("#")]),s._v(" computed")]),s._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[s._v("实现思想")]),s._v(" "),n("ul",[n("li",[s._v("计算属性是一个effect，_dirty=true触发执行")]),s._v(" "),n("li",[s._v("计算属性的依赖属性会搜集这个effect")]),s._v(" "),n("li",[s._v("计算属性具备依赖搜集的功能，会搜集对应的effect方法")]),s._v(" "),n("li",[s._v("第一次执行effect方法时会取computed中的值 _dirty=true，此时如果多次执行就走缓冲")]),s._v(" "),n("li",[s._v("计算属性依赖的属性值发生变化了，将_dirty=true，触发计算属性搜集的effect，这样就会重新计算计算属性的值")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('import { isFunction } from "@vue/shared";\nimport { isTracking, ReactiveEffect, trackEffects } from "./effect";\n\nclass ComputedRefImpl {\n    public dep: Set<ReactiveEffect> = new Set<ReactiveEffect>();  //等价于this.dep=undefined\n    private _dirty: boolean = true; //等价于this._dirty=true\n    private __v_isRef: boolean = true; //等价于this.__v_isRef=true\n    public effect: ReactiveEffect = new ReactiveEffect(() => { });//用effect包装\n    private _value: any;//保存effect.run()的结果\n\n    constructor(getter: any, public setter: any) {\n        //这里将计算属性变成了effect，那么计算属性中的属性就会搜集这个effect\n        //将计算属性包装成effect\n        this.effect = new ReactiveEffect(getter, () => {\n            //计算属性的值发生变化了，那么就不要重新执行计算属性，而是去调用此函数\n            if (!this._dirty) {\n                this._dirty = true\n                //triggerEffects(this.dep)\n            }\n        })\n    }\n\n    get value() {//如果取值的时候会触发get方法\n        if (isTracking()) {\n            trackEffects(this.dep)\n        }\n\n        if (this._dirty) {\n            this._value = this.effect.run()//将结果缓冲在this._value中，不用每次都run\n            this._dirty = false\n        }\n        return this._value\n    }\n\n    set value(newValue) {//如果修改属性的值就触发这个set方法\n        this.setter(newValue)\n    }\n}\n\nexport function computed(getterOrOptions: unknown) {\n    const onlyGetter = isFunction(getterOrOptions)\n    let setter;\n    let getter;\n\n    if (onlyGetter) {\n        getter = getterOrOptions\n        setter = () => { }\n    } else {\n        getter = (getterOrOptions as any).get\n        setter = (getterOrOptions as any).set\n    }\n\n    return new ComputedRefImpl(getter, setter)\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br"),n("span",{staticClass:"line-number"},[s._v("52")]),n("br"),n("span",{staticClass:"line-number"},[s._v("53")]),n("br"),n("span",{staticClass:"line-number"},[s._v("54")]),n("br")])]),n("h2",{attrs:{id:"ref"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#ref"}},[s._v("#")]),s._v(" ref")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('import { isObject } from "@vue/shared"\nimport { isTracking, ReactiveEffect, trackEffects, triggerEffects } from "./effect"\nimport { reactive, toReactive } from "./reactive"\n\nclass RefImpl {\n    public dep: Set<ReactiveEffect> = new Set<ReactiveEffect>\n    public __v_isRef: boolean = true\n    public _value: any\n    constructor(public _rawValue: any) {\n        this._value = toReactive(_rawValue)\n    }\n\n    //类是属性访问器最终会变成defineProperty\n    get value() {//取值的时候进行依赖搜集\n        if (isTracking()) {\n            trackEffects(this.dep)\n        }\n        return this._value\n    }\n    set value(newValue) {//赋值的时候触发更新\n        if (newValue !== this._rawValue) {\n            this._rawValue = newValue\n            this._value = reactive(newValue)\n            //triggerEffects(this.dep)\n        }\n    }\n}\n\nfunction createRef(value: any) {\n    return new RefImpl(value)\n}\n\nexport function ref(value: any) {\n    return createRef(value)\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br")])])],1)}),[],!1,null,null,null);n.default=t.exports}}]);